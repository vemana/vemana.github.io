<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>How to run JUnit tests in parallel with Virtual Threads. | Vemana's Space.</title> <meta name="author" content="Subrahmanyam "> <meta name="description" content="Using Virtual Threads can deliver more utilization on I/O bound tasks."> <meta name="keywords" content="software-engineering, math"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://vemana.github.io/blog/2023/junit-parallel-test-runner/"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Vemana's Space.</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">How to run JUnit tests in parallel with Virtual Threads.</h1> <p class="post-meta">December 25, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/software-testing"> <i class="fas fa-hashtag fa-sm"></i> software-testing</a>     ·   <a href="/blog/category/software-engineering"> <i class="fas fa-tag fa-sm"></i> software-engineering</a>   </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"><a href="#context">Context</a></li> <li class="toc-entry toc-h2"><a href="#options--decision">Options &amp; Decision</a></li> <li class="toc-entry toc-h2"><a href="#why-virtual-threads">Why Virtual Threads?</a></li> <li class="toc-entry toc-h2"><a href="#code">Code</a></li> </ul> </div> <hr> <div id="markdown-content"> <h2 id="context">Context</h2> <p>I want to run some Java JUnit tests in parallel while retaining one-time static setup. Specifically,</p> <ul> <li>I have an integration test class that spins up a database and performs some tests</li> <li>The test’s <code class="language-plaintext highlighter-rouge">@BeforeClass void spinupDb()</code> spins up a database. I want this to run only once for the entire test class</li> <li>I want the test cases to run in parallel</li> <li>Run under Bazel and JUnit4</li> </ul> <p>Contrast with the standard <code class="language-plaintext highlighter-rouge">JUnit4</code> Runner which executes all the tests serially in the same thread:</p> <ul> <li>The thread Executes the static <code class="language-plaintext highlighter-rouge">@BeforeClass void spinupDb()</code> </li> <li>Thereafter, the thread runs each test in serial</li> </ul> <p>The primary motivation to consider parallel runs is to quicken the test feedback cycle.</p> <hr> <h2 id="options--decision">Options &amp; Decision</h2> <p>Suppose I have 20 test cases and one db spin up (in a one-time, static, setup method) in my test class.</p> <p>The primary options are:</p> <ul> <li>Do nothing and pay for serial execution <ul> <li>Time to completion = Db spin up time + time to complete 20 tests</li> </ul> </li> <li>Use <a href="https://bazel.build/reference/test-encyclopedia#test-sharding" rel="external nofollow noopener" target="_blank">Bazel’s test sharding</a>. With a <code class="language-plaintext highlighter-rouge">shard_count=5</code>, <ul> <li>It splits 20 test cases into 5 shards of 4 each (give or take one or two depending on randomization)</li> <li>Each test shard will spin up the database and then run each of its 4 tests in serial</li> <li>Time to completion = Db spin up time + time to complete 4 tests</li> </ul> </li> <li>Use JUnit’s experimental <a href="https://github.com/junit-team/junit4/blob/main/src/main/java/org/junit/experimental/ParallelComputer.java" rel="external nofollow noopener" target="_blank">Parallel Computer</a>. This meets the spec except that JUnit doesn’t expose a runner like <code class="language-plaintext highlighter-rouge">ParallelRunner</code>. <ul> <li>Time to completion = Db spin up time + time to complete <code class="language-plaintext highlighter-rouge">20/T</code> tests where <code class="language-plaintext highlighter-rouge">T</code> is the number of parallel threads</li> </ul> </li> <li>Roll my own, inspired by <code class="language-plaintext highlighter-rouge">Parallel Computer</code> <ul> <li>And take the opportunity to run using Virtual Threads !</li> <li>Time to completion = Db spin up time + time to complete 1 test</li> </ul> </li> </ul> <p>I chose to roll a new parallel Runner because it meets the spec and I can also use Virtual Threads.</p> <hr> <h2 id="why-virtual-threads">Why Virtual Threads?</h2> <p>Java Virtual Threads are many things. Perhaps the most well known is their ability to deliver straight-line programs (no Reactive Java please!). Perhaps less well known is its utilization benefits: you can get more out of your servers. Why so? It goes to Little’s law; see <a href="https://www.youtube.com/watch?v=YQ6EpIk7KgY" rel="external nofollow noopener" target="_blank">Ron Pressler’s explanation</a>.</p> <p>Platform Threads (i.e. traditional Java threads) are heavy</p> <ul> <li>They use significant memory</li> <li>Context switching across them is expensive</li> <li>So, there’s an upper bound on number of concurrent threads per core</li> <li>As you approach this bound, the system runs out of memory and/or switching costs dominate the actual useful on-cpu work</li> </ul> <p>Virtual Threads are light</p> <ul> <li>They have small memory footprint (IIRC, a few KB vs a few MB for Platform threads)</li> <li>Switching is quite cheap (since it is done by the JVM not the OS)</li> <li>So, the upper bound on number of concurrent threads is a LOT higher; perhaps 100-1000x higher</li> </ul> <p>In some situations, Virtual Threads can support more load per core</p> <ul> <li>Suppose that you have a workload where each request (runs in a single thread), waits on IO for 199 units and does 1 unit of work</li> <li>In the steady state, assuming zero switching costs and perfect alignment, a core needs to queue 200 threads <ul> <li>Each of the 200 threads is blocked for 199 units, does 1 unit of work and repeats the cycle</li> </ul> </li> <li>Suppose the core can support a max of 100 Platform Threads and 10,000 Virtual Threads</li> <li>To obtain a queue size of 200, you’ll need two cores running Platform Threads vs 1 core running Virtual Threads</li> <li><span style="color:green; font-weight:bold;">In other words, you need fewer servers using Virtual Threads to support the same workload</span></li> </ul> <p>If you have 10 testing boxes running integration tests, it’s plausible you can cut down on a couple using Virtual Threads because</p> <ul> <li>Integration tests with databases could have similar characteristics as the example above</li> <li>Each test waits on database and consumes relatively little CPU (though not as extreme as 1:199)</li> <li>The test’s database consumes CPU but it reads from disk for queries/reads/writes</li> <li>If you run database from memory (instead of disk), thereby IO no longer being bottleneck, memory could become the new bottleneck</li> </ul> <blockquote class="block-warning"> <p>Bottomline: Virtual Threads are worth a try for integration tests.</p> </blockquote> <hr> <h2 id="code">Code</h2> <p>This is how the test looks.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @ParallelTestMethodsConfig(platformThreads = 10)   // Option 1: Use 10 Platform Threads</span>
<span class="c1">// @ParallelTestMethodsConfig(platformThreads = -1)   // Option 2: Use unbounded Platform Threads</span>
<span class="nd">@ParallelTestMethodsConfig</span><span class="o">(</span><span class="n">useVirtualThreads</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>  <span class="c1">// Option 3: Use Virtual Threads</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="nc">ParallelTestMethodsRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDbTest</span> <span class="o">{</span>

  <span class="c1">// Runs once per test class, ahead of any test case.</span>
  <span class="c1">// Spins up the database.</span>
  <span class="c1">// `dbTestCase` field is shared and used by all the test cases.</span>
  <span class="nd">@ClassRule</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">DbTestCase</span> <span class="n">dbTestCase</span> <span class="o">=</span> <span class="nc">DbTestCase</span><span class="o">.</span><span class="na">postgres_15_3</span><span class="o">();</span>

  <span class="c1">// Runs once per test case.</span>
  <span class="c1">// Different tests use different 'database' (as in `USE DATABASE D;` of MySql)</span>
  <span class="c1">// to avoid mutual interference.</span>
  <span class="c1">// Creates a new 'database' and creates tables in them, ready for the test</span>
  <span class="c1">// to use.</span>
  <span class="nd">@Rule</span>
  <span class="kd">public</span> <span class="nc">SchemaApplier</span> <span class="n">schemaApplier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SchemaApplier</span><span class="o">(</span><span class="n">dbTestCase</span><span class="o">);</span>

  <span class="nd">@Test</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="o">()</span> <span class="o">{...}</span>
  <span class="nd">@Test</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_2</span><span class="o">()</span> <span class="o">{...}</span>
  <span class="c1">// ...</span>
  <span class="nd">@Test</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_20</span><span class="o">()</span> <span class="o">{...}</span>
<span class="o">}</span>
</code></pre></div></div> <hr> <p>Note the following:</p> <ul> <li>A new Runner, <code class="language-plaintext highlighter-rouge">ParallelTestMethodsRunner</code> </li> <li>The test configuration <code class="language-plaintext highlighter-rouge">ParallelTestMethodsConfig</code> which supports two options <ul> <li>Run using Platform Threads (for CPU bound tests)</li> <li>Run using Virtual Threads (for IO bound tests)</li> </ul> </li> </ul> <hr> <p>The Runner is fairly trivial to implement based on JUnit’s <code class="language-plaintext highlighter-rouge">Parallel Computer</code>.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Runs test methods in parallel; they all share the same static setup.
 *
 * &lt;p&gt;It is VERY tricky to have parallel tests working because they will run into resource issues.
 * For example, you can quickly run out of database connections if you have 100 tests in parallel
 * and the db has a 100 connection limit. So, in that sense, more coordination is required to have
 * tests run in parallel.
 *
 * &lt;p&gt;Running tests in parallel does have one great advantage: it cuts down iteration time. So, it
 * is a balance and caution should be exercised in choosing this method. Test sharding in Bazel is
 * also a viable alternative except that it uses extra CPU since it repeats the test setup for each
 * shard. So, if you are running on a local workstation, it is perhaps better to iterate using this
 * runner than using Bazel shards.
 *
 * &lt;p&gt;Configuration must be specified via {@link ParallelTestMethodsConfig} annotation on the test
 * class.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ParallelTestMethodsRunner</span> <span class="kd">extends</span> <span class="nc">BlockJUnit4ClassRunner</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nf">ParallelTestMethodsRunner</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">testClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InitializationError</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">testClass</span><span class="o">);</span>
    <span class="nc">ParallelTestMethodsConfig</span> <span class="n">config</span> <span class="o">=</span>
        <span class="nc">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span>
            <span class="n">testClass</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">ParallelTestMethodsConfig</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
            <span class="s">"%s requires a config annotation of type: %s"</span><span class="o">,</span>
            <span class="nc">ParallelTestMethodsRunner</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
            <span class="nc">ParallelTestMethodsConfig</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
    <span class="n">setScheduler</span><span class="o">(</span><span class="k">new</span> <span class="nc">Scheduler</span><span class="o">(</span><span class="n">config</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Configuration for {@link ParallelTestMethodsRunner},
   */</span>
  <span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
  <span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">ParallelTestMethodsConfig</span> <span class="o">{</span>

    <span class="cm">/**
     * The number of threads that methods will be parallelized into. A threadpool Executor will be
     * used to multiplex all the test methods. This value determines the size of the threadpool.
     *
     * &lt;p&gt;A value less than 1 specifies an unbounded threadpool.
     */</span>
    <span class="kt">int</span> <span class="nf">platformThreads</span><span class="o">()</span> <span class="k">default</span> <span class="mi">5</span><span class="o">;</span>

    <span class="cm">/**
     * Whether to use virtual threads. If set, a {@link Executors#newVirtualThreadPerTaskExecutor()}
     * will be used to run the test methods. {@link ParallelTestMethodsConfig#platformThreads()} is
     * not meaningful when this is true.
     */</span>
    <span class="kt">boolean</span> <span class="nf">useVirtualThreads</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Scheduler</span> <span class="kd">implements</span> <span class="nc">RunnerScheduler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExecutorService</span> <span class="n">service</span><span class="o">;</span>

    <span class="nc">Scheduler</span><span class="o">(</span><span class="nc">ParallelTestMethodsConfig</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">service</span> <span class="o">=</span>
          <span class="n">config</span><span class="o">.</span><span class="na">useVirtualThreads</span><span class="o">()</span>
              <span class="o">?</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newVirtualThreadPerTaskExecutor</span><span class="o">()</span>
              <span class="o">:</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">platformThreads</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">1</span>
                     <span class="o">?</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">()</span>
                     <span class="o">:</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">platformThreads</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">finished</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">service</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="n">service</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedule</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/webscale-swe-skillset/">The Web-scale Software Engineer Skillset</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/10mmm-memory-model/">Hardware Memory Models: 10 Minute Mental Model</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/testing-calculator-homomorphism/">Can software testing be objective? Hello from Homomorphisms.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/abiyz-intro/">How to think about programs &amp; programming? ABIYZ: inspired by age old tools like arithmetic.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/money-from-symmetry/">What is Money and where does it come from? An answer from symmetry.</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Subrahmanyam . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js" integrity="sha256-mm3Re3y7xlvh+yCD+l/Zs1d+PU0AEad93MkWvljfm/s=" crossorigin="anonymous"></script> <script>$(document).ready(function(){mermaid.initialize({startOnLoad:!0,theme:"default"}),window.mermaid.init(undefined,document.querySelectorAll(".language-mermaid"))});</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>